## 1.  balances RLS 생성

조회 : 부모/자녀 서로 가능, 본인

쓰기 : 서버만 가능

```sql
-- 0) RLS 켜기
ALTER TABLE public.balances ENABLE ROW LEVEL SECURITY;

-- 1) (있다면) 기존 정책 제거
DROP POLICY IF EXISTS "balances_select_policy"  ON public.balances;
DROP POLICY IF EXISTS "balances_insert_policy"  ON public.balances;
DROP POLICY IF EXISTS "balances_update_policy"  ON public.balances;
DROP POLICY IF EXISTS "balances_delete_policy"  ON public.balances;

-- 2) SELECT: 나 자신 or 부모-자녀로 연결된 상대의 잔액 조회 허용
CREATE POLICY "balances_select_policy"
ON public.balances
FOR SELECT
USING (
    -- 나 자신
    is_me_user_id(balances.user_id)
    -- 가족 관계(부모/자녀)면 허용
    OR EXISTS (
    SELECT 1
    FROM public.relations r
    WHERE (
        -- 내가 부모이고 balances의 주인이 자녀
        r.parent_id = uid_to_user_id(auth.uid()) AND r.child_id  = balances.user_id
    ) OR (
        -- 내가 자녀이고 balances의 주인이 부모
        r.child_id  = uid_to_user_id(auth.uid()) AND r.parent_id = balances.user_id
    )
    )
);

-- 3) INSERT/UPDATE/DELETE: 서비스 로직(트리거/Edge Function)만 가능
--    (client에서 직접 재화 변경 불가)
CREATE POLICY "balances_insert_policy"
ON public.balances
FOR INSERT TO service_role
WITH CHECK (true);

CREATE POLICY "balances_update_policy"
ON public.balances
FOR UPDATE TO service_role
USING (true)
WITH CHECK (true);

CREATE POLICY "balances_delete_policy"
ON public.balances
FOR DELETE TO service_role
USING (true);

```

<br><br>

## 2. quests RLS 생성

부모 : 읽기, 쓰기 가능

자녀 : 읽기, update만 가능 (완료 요청 시, status 바꾸기 위함)

```sql
-- 0) RLS 켜기
ALTER TABLE public.quests ENABLE ROW LEVEL SECURITY;

-- 기존 정책 제거
DROP POLICY IF EXISTS "quests_select_related" ON public.quests;
DROP POLICY IF EXISTS "quests_insert_parent_only" ON public.quests;
DROP POLICY IF EXISTS "quests_update_related" ON public.quests;
DROP POLICY IF EXISTS "quests_delete_parent_only" ON public.quests;

-- 1) SELECT: 부모/자녀 모두 "자기와 관련된" 퀘스트만 조회
CREATE POLICY "quests_select_related"
ON public.quests
FOR SELECT
USING (
    uid_to_user_id(auth.uid()) IN (quests.parent_id, quests.child_id)
);

-- 2) INSERT: 부모만 생성 가능 (+ 자신이 parent_id여야 함, parent-child 관계 유효성 체크)
CREATE POLICY "quests_insert_parent_only"
ON public.quests
FOR INSERT
WITH CHECK (
    -- 요청자가 이 퀘스트의 부모여야 함
    uid_to_user_id(auth.uid()) = quests.parent_id
    -- (선택) 관계가 실제로 존재하고 활성인지 검증
    AND EXISTS (
    SELECT 1
    FROM public.relations r
    WHERE r.parent_id = quests.parent_id
        AND r.child_id  = quests.child_id
        AND r.status = 'ACTIVE'::public.relation_status  -- enum 쓰지 않으면 r.status='ACTIVE'
    )
);

-- 3) UPDATE: 부모/자녀 모두 "자신과 관련된" 퀘스트만 수정 가능
--    (자녀가 완료요청, 부모가 승인까지 하는 흐름을 지원)
CREATE POLICY "quests_update_related"
ON public.quests
FOR UPDATE
USING (
    uid_to_user_id(auth.uid()) IN (quests.parent_id, quests.child_id)
)
WITH CHECK (
    uid_to_user_id(auth.uid()) IN (quests.parent_id, quests.child_id)
);

-- 4) DELETE: 일반적으로 부모만 삭제 허용 (원하면 service_role만 허용으로 바꿔도 됨)
CREATE POLICY "quests_delete_parent_only"
ON public.quests
FOR DELETE
USING (
    uid_to_user_id(auth.uid()) = quests.parent_id
);

```