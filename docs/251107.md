## 1. 유저 첫 로그인시, auth.users엔 추가되는데, users엔 안나오는 문제

내가 users테이블에 필터 걸어서 조회해서 없는걸로 보였던것.

때문에, 애꿎은 RLS만 갈아엎음

지금 ‘Users can update only their own data’ , ‘Users can view only their own data’만 걸려있어서

예전에 해결했던 문제 다시 발생할 듯..

<br><br>

## 2. 자식이 부모가 보낸 요청 보내기 위한 RLS 설정

```sql
-- uid -> user_id 자주 쓸듯.
CREATE OR REPLACE FUNCTION public.uid_to_user_id(uid uuid)
RETURNS bigint
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
    SELECT u.id
    FROM public.users u
    WHERE u.auth_user_id = uid
    LIMIT 1;
$$;

-- RLS 추가
CREATE POLICY "Users: parent of my incoming relation"
ON public.users
FOR SELECT
TO authenticated
USING (
    EXISTS (
    SELECT 1
    FROM public.relations r
    WHERE r.parent_id = users.id       -- bigint 매칭
        AND r.child_id  = public.uid_to_user_id(auth.uid()) -- uid→내 users.id 로 변환하는 함수 필요
        AND r.status IN ('PENDING','ACTIVE')
    )
);
```