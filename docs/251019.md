## 1. RLS(ì •ì±…) - usersì— auth_user_id ì¶”ê°€í•´ë†ˆ.

| í…Œì´ë¸” | ì ‘ê·¼ ê°€ëŠ¥ ëŒ€ìƒ | ì£¼ìš” ì¡°ê±´ | ì„¤ëª… |
| --- | --- | --- | --- |
| **users** | ë³¸ì¸ë§Œ | `auth_user_id = auth.uid()` | ìœ ì € ìì‹ ì˜ í”„ë¡œí•„ë§Œ ì¡°íšŒ ë° ìˆ˜ì • ê°€ëŠ¥ |
| **relations** | ë¶€ëª¨, ìë…€ | `parent_id` ë˜ëŠ” `child_id`ê°€ ë¡œê·¸ì¸ ìœ ì € | ë¶€ëª¨-ìë…€ ê´€ê³„ì— ì†í•œ ì‚¬ìš©ìë§Œ ê´€ê³„ ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥ |
| **quests** | ë¶€ëª¨, ìë…€ | `parent_id` ë˜ëŠ” `child_id`ê°€ ë¡œê·¸ì¸ ìœ ì € | ë¶€ëª¨ëŠ” ë“±ë¡ ë° ìƒíƒœ ë³€ê²½ ê°€ëŠ¥ / ìë…€ëŠ” ìˆ˜í–‰ë§Œ ê°€ëŠ¥ |
| **shop_items** | ëª¨ë‘ ì¡°íšŒë¶€ëª¨ë§Œ ë“±ë¡/ìˆ˜ì • | `u.role = 'PARENT'` | ë¶€ëª¨ê°€ ìƒì  ì•„ì´í…œ ë“±ë¡ / ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥ |
| **shop_purchases** | ìë…€ ë³¸ì¸ | `child_id`ê°€ ë¡œê·¸ì¸ ìœ ì € | ìë…€ê°€ ìê¸° êµ¬ë§¤ ë‚´ì—­ ì¡°íšŒ ë° ë“±ë¡ ê°€ëŠ¥ |
| **bank_items** | ëª¨ë‘ ì¡°íšŒê´€ë¦¬ìë§Œ ìˆ˜ì • | `auth.role() = 'service_role'` | ì€í–‰ ìƒí’ˆì€ ê´€ë¦¬ìë§Œ ê´€ë¦¬ ê°€ëŠ¥ |
| **bank_purchases** | ë¶€ëª¨ ë³¸ì¸ | `parent_id`ê°€ ë¡œê·¸ì¸ ìœ ì € | ë¶€ëª¨ê°€ ë³¸ì¸ì˜ ì¶©ì „ ë‚´ì—­ ì¡°íšŒ ë° ë“±ë¡ ê°€ëŠ¥ |
| **balances** | ë³¸ì¸ ë˜ëŠ” ë¶€ëª¨ | ë³¸ì¸ or `relations`ë¥¼ í†µí•œ ë¶€ëª¨ | ìë…€ ë³¸ì¸ + ê´€ê³„ëœ ë¶€ëª¨ê°€ ì”ì•¡ ì¡°íšŒ ê°€ëŠ¥ |
| **transactions** | ë³¸ì¸ ë˜ëŠ” ë¶€ëª¨ | ë³¸ì¸ or `relations`ë¥¼ í†µí•œ ë¶€ëª¨ | ìë…€ ë³¸ì¸ + ê´€ê³„ëœ ë¶€ëª¨ê°€ ê±°ë˜ë‚´ì—­ ì¡°íšŒ ê°€ëŠ¥ |

```sql
-- users
ALTER TABLE users
ADD COLUMN auth_user_id UUID UNIQUE;
```

```sql
-- 1ï¸âƒ£ RLS í™œì„±í™”
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE relations ENABLE ROW LEVEL SECURITY;
ALTER TABLE quests ENABLE ROW LEVEL SECURITY;
ALTER TABLE shop_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE shop_purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE bank_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE bank_purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE balances ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- 2ï¸âƒ£ users
CREATE POLICY "Users can view only their own data"
ON users
FOR SELECT
USING (auth_user_id = auth.uid());

CREATE POLICY "Users can update only their own data"
ON users
FOR UPDATE
USING (auth_user_id = auth.uid());

-- 3ï¸âƒ£ relations
CREATE POLICY "View own relations"
ON relations
FOR SELECT
USING (
    parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
    OR child_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

-- 4ï¸âƒ£ quests
CREATE POLICY "View own or related quests"
ON quests
FOR SELECT
USING (
    parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
    OR child_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Child can update their own quests"
ON quests
FOR UPDATE
USING (
    child_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Parent can update quest status"
ON quests
FOR UPDATE
USING (
    parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

-- 5ï¸âƒ£ shop_items
CREATE POLICY "Everyone can view shop items"
ON shop_items
FOR SELECT
USING (TRUE);

CREATE POLICY "Only parents can manage shop items"
ON shop_items
FOR ALL
USING (
    EXISTS (
    SELECT 1
    FROM users u
    WHERE u.auth_user_id = auth.uid() AND u.role = 'PARENT'
    )
)
WITH CHECK (
    EXISTS (
    SELECT 1
    FROM users u
    WHERE u.auth_user_id = auth.uid() AND u.role = 'PARENT'
    )
);

-- 6ï¸âƒ£ shop_purchases
CREATE POLICY "Children can view their own shop purchases"
ON shop_purchases
FOR SELECT
USING (
    child_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Children can insert their own shop purchases"
ON shop_purchases
FOR INSERT
WITH CHECK (
    child_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

-- 7ï¸âƒ£ bank_items
CREATE POLICY "Everyone can view bank items"
ON bank_items
FOR SELECT
USING (TRUE);

CREATE POLICY "Only service_role can modify bank items"
ON bank_items
FOR ALL
USING (auth.role() = 'service_role')
WITH CHECK (auth.role() = 'service_role');

-- 8ï¸âƒ£ bank_purchases
CREATE POLICY "Parents can view their own bank purchases"
ON bank_purchases
FOR SELECT
USING (
    parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Parents can insert their own bank purchases"
ON bank_purchases
FOR INSERT
WITH CHECK (
    parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

-- 9ï¸âƒ£ balances
CREATE POLICY "View own or child's balance"
ON balances
FOR SELECT
USING (
    user_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
    OR EXISTS (
    SELECT 1 FROM relations r
    WHERE r.child_id = balances.user_id
        AND r.parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
        AND r.status = 'ACTIVE'
    )
);

CREATE POLICY "Update own balance only"
ON balances
FOR UPDATE
USING (
    user_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

-- ğŸ”Ÿ transactions
CREATE POLICY "View own or child's transactions"
ON transactions
FOR SELECT
USING (
    user_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
    OR EXISTS (
    SELECT 1 FROM relations r
    WHERE r.child_id = transactions.user_id
        AND r.parent_id IN (SELECT id FROM users WHERE auth_user_id = auth.uid())
        AND r.status = 'ACTIVE'
    )
);

```
<br><br>

## 2. auth.users â†’ users ìë™ ì¶”ê°€ íŠ¸ë¦¬ê±°
    
```sql
CREATE OR REPLACE FUNCTION public.handle_new_auth_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.users (
    auth_user_id,
    nickname,
    tag,
    role,
    created_at,
    updated_at
    )
    VALUES (
    NEW.id,                             -- Supabase Auth user.id (UUID)
    NULL,                               -- ë‹‰ë„¤ì„ ì—†ìŒ
    lpad(to_hex(floor(random() * 65536)::int), 4, '0'), -- 4ìë¦¬ ëœë¤ HEX tag
    'DEFAULT',                          -- ê¸°ë³¸ ì—­í• 
    NOW(),
    NOW()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================
-- íŠ¸ë¦¬ê±° ë“±ë¡
-- =============================
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE PROCEDURE public.handle_new_auth_user();

```

<br><br>

## 3. rpc - ë¶€ëª¨ê°€ ìë…€ë¥¼ usersì—ì„œ ì¡°íšŒí•  ë•Œ,  RLSì— ë§‰í˜€ì„œ ë§Œë“¬.
    
```sql
-- 1) ìë…€ ê²€ìƒ‰ìš© RPC í•¨ìˆ˜
create or replace function public.find_child_by_tag(
    _nickname text,
    _tag text
)
returns table(id bigint, nickname text, tag text)
language sql
security definer
set search_path = public
as $$
    select u.id, u.nickname, u.tag
    from public.users u
    where u.role = 'CHILD'::user_role
    and u.nickname = _nickname
    and u.tag = _tag
    limit 1;
$$;

-- 2) ê¶Œí•œ ë¶€ì—¬: ì•±ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡
grant execute on function public.find_child_by_tag(text, text) to anon, authenticated;

```