# ERD Supabase script

```sql
-- =============================
-- ENUM 타입
-- =============================
CREATE TYPE user_role AS ENUM ('DEFAULT', 'PARENT', 'CHILD');
CREATE TYPE quest_status AS ENUM ('REGISTERED', 'REQUESTED', 'COMPLETED', 'REJECTED');
CREATE TYPE transaction_type AS ENUM (
    'QUEST_REWARD',      -- 퀘스트 보상 지급
    'SHOP_PURCHASE',     -- 상점 구매(재화 소모)
    'BANK_PURCHASE',     -- 은행(현금->재화) 충전
    'ADJUSTMENT'         -- 관리자/오류 보정 등
);
CREATE TYPE currency_unit AS ENUM ('COIN', 'KRW');
CREATE TYPE relation_status AS ENUM ('PENDING', 'ACTIVE', 'BLOCKED');
CREATE TYPE reference_type AS ENUM ('QUEST', 'SHOP_PURCHASE', 'BANK_PURCHASE');

-- =============================
-- users
-- =============================
CREATE TABLE public.users (
    id BIGSERIAL PRIMARY KEY,
    auth_user_id UUID UNIQUE,             -- Supabase Auth의 user.id(UUID)
    nickname TEXT NULL,                   -- 기본값 없이, NULL 허용
    tag VARCHAR(8) NULL,                  -- 생성 시 랜덤 생성
    role user_role NOT NULL DEFAULT 'DEFAULT', -- 기본값 DEFAULT
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT unique_nickname_tag UNIQUE (nickname, tag),
    CONSTRAINT chk_tag_format CHECK (char_length(tag) <= 8)
);

-- =============================
-- relations (부모-자녀 관계)
-- =============================
CREATE TABLE relations (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    child_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status relation_status DEFAULT 'ACTIVE',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE (parent_id, child_id)
);

-- =============================
-- quests (의뢰)
-- =============================
CREATE TABLE quests (
    id BIGSERIAL PRIMARY KEY,
    relation_id BIGINT NOT NULL REFERENCES relations(id) ON DELETE CASCADE,
    parent_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    child_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    content TEXT,
    reward INT NOT NULL DEFAULT 0, -- 지급할 재화 단위 (COIN 단위)
    status quest_status DEFAULT 'REGISTERED',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE NULL
);

-- =============================
-- shop_items (부모가 등록하는 상점 상품)
-- =============================
CREATE TABLE shop_items (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- 상점 주인(부모)
    title TEXT NOT NULL,
    content TEXT,
    price INT NOT NULL, -- 재화 단위 (COIN)
    currency currency_unit DEFAULT 'COIN',
    image_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- bank_items (관리자가 등록하는 은행 상품)
-- =============================
CREATE TABLE bank_items (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT NULL REFERENCES users(id) ON DELETE SET NULL, -- NULL 허용: 관리자 등록
    title TEXT NOT NULL,
    content TEXT,
    price INT NOT NULL, -- 현금 기준 금액(예: 원 단위)
    currency currency_unit DEFAULT 'KRW',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- shop_purchases (자녀의 상점 구매 내역)
-- =============================
CREATE TABLE shop_purchases (
    id BIGSERIAL PRIMARY KEY,
    child_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,    -- 구매자 (child)
    shop_item_id BIGINT NOT NULL REFERENCES shop_items(id) ON DELETE RESTRICT,
    price_paid INT NOT NULL, -- 당시 지불된 재화(코인)
    quantity INT NOT NULL DEFAULT 1 CHECK (quantity > 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- bank_purchases (부모의 현금 결제 내역)
-- =============================
CREATE TABLE bank_purchases (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- 결제한 부모
    bank_item_id BIGINT NOT NULL REFERENCES bank_items(id) ON DELETE RESTRICT,
    amount INT NOT NULL, -- 결제 금액 (KRW 단위)
    coins_granted INT NOT NULL DEFAULT 0, -- 실제 충전된 재화(코인)
    currency currency_unit DEFAULT 'KRW',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- balances (유저의 재화 잔액)
-- =============================
CREATE TABLE balances (
    user_id BIGINT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    balance INT NOT NULL DEFAULT 0 CHECK (balance >= 0),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- transactions (재화 흐름 로그)
-- =============================
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- 거래 대상
    type transaction_type NOT NULL,
    amount INT NOT NULL, -- +면 충전, -면 소모
    reference_type reference_type NULL,
    reference_id BIGINT NULL,
    note TEXT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================
-- 인덱스
-- =============================
CREATE INDEX idx_quests_relation_id ON quests(relation_id);
CREATE INDEX idx_shop_purchases_child_id ON shop_purchases(child_id);
CREATE INDEX idx_bank_purchases_parent_id ON bank_purchases(parent_id);
CREATE INDEX idx_transactions_user_id ON transactions(user_id);

-- =============================
-- updated_at 자동 갱신 트리거
-- =============================
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_set_updated_at_users
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE PROCEDURE set_updated_at();

CREATE TRIGGER trg_set_updated_at_quests
BEFORE UPDATE ON quests
FOR EACH ROW
EXECUTE PROCEDURE set_updated_at();

CREATE TRIGGER trg_set_updated_at_shop_items
BEFORE UPDATE ON shop_items
FOR EACH ROW
EXECUTE PROCEDURE set_updated_at();

CREATE TRIGGER trg_set_updated_at_bank_items
BEFORE UPDATE ON bank_items
FOR EACH ROW
EXECUTE PROCEDURE set_updated_at();

-- =============================
-- 운영 주의사항
-- - balance 변경 + transactions 기록은 항상 하나의 트랜잭션으로 처리
-- - shop_purchases, bank_purchases는 RESTRICT로 설정해 로그 무결성 보장
-- - Supabase RLS 적용 시 auth.uid() 기반 정책을 반드시 적용
-- =============================

```